#Create test secret
kubectl create secret generic test-secret --from-literal username=user --from-literal password=P@ssw0rd

#To check if a secret is encrypted or not use the following tool (install on the master node)
sudo apt install etcd-client

#See the secret (default stands for the namespace)
sudo ETCDCTL_API=3 etcdctl \
   --cert=/etc/kubernetes/pki/etcd/server.crt \
   --key=/etc/kubernetes/pki/etcd/server.key \
   --cacert=/etc/kubernetes/pki/etcd/ca.crt \
   get /registry/secrets/default/test-secret

#Secrets can also be viewed with a text editor from the path: /var/lib/etcd/member/snap/db
#The file is a binary file

#The example will use the secret box encryption provider
#Create a 32 byte secret text with base64 encoding
head -c 32 /dev/urandom | base64

#To set the key we need to specify it in a yml file which has to be mounted with a volume
#The following folder is already mounted with a volume so we will put the data there to make it easier: /etc/kubernetes/pki/
sudo nano /etc/kubernetes/pki/enc-config.yaml
#Write
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - secretbox:
          keys:
            - name: key1
              secret: <base64_encoded_key>
      - identity: {} # default encryption provider to allow reading unencrypted secrets
###

#Now we need to modify the kube-apiserver config file
sudo nano /etc/kubernetes/manifests/kube-apiserver.yaml
#add the line: - --encryption-provider-config=/etc/kubernetes/pki/enc-config.yaml
#Add it before:    - --enable-admission-plugins=NodeRestriction
#After saving the file the kube-apiserver container will restart

#Use this command to make sure that the parameter is used now
sudo ps -ef | grep kube-apiserver | grep "encryption-provider-config" 

#To encrypt existing secrets run
kubectl get secrets --all-namespaces -o json | kubectl replace -f -

#Example of ansible tasks for doing enc
---
- hosts: local
  tasks:
  - name: Generate 32 byte secret
    shell: head -c 32 /dev/urandom | base64
    register: secret_key
    changed_when: false
  - name: Ansible replace string example
    replace:
      path: /home/user100/testfile
      regexp: 'secret_key'
      replace: "{{ secret_key.stdout }}"
  - name: Add the encryption parameter to kube-apiserver config file
    lineinfile:
      path: /home/user100/testfile2
      insertbefore: '    - --enable-admission-plugins=NodeRestriction'
      line: '    - --encryption-provider-config=/etc/kubernetes/pki/enc-config.yaml'