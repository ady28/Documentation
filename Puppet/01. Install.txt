###Server
#Add package repo to centos
sudo yum install https://yum.puppet.com/puppet6-release-el-7.noarch.rpm
#Add package repo to ubuntu
curl https://apt.puppet.com/puppet6-release-focal.deb -x "http://192.168.1.254:80" --output puppetserver.deb
sudo dpkg -i puppetserver.deb

#Update the repository then install puppet server
yum install -y puppetserver
apt install -y puppetserver

#Exit the current session or start a new one and check the install
puppet --version

#Run puppet directly as root for sudo commands
sudo -i

#Run some local commands to configure some OS parts
puppet apply -e 'package {"chrony": ensure => installed}'
puppet apply -e 'service {"chronyd": ensure => running , enable => true}'

#Open firewall port (ubuntu)
sudo ufw allow 8140/tcp

#Modify agent settings to point to puppet server and use proxy
sudo nano /etc/puppetlabs/puppet/puppet.conf
#Add
[main]
server = ubuntu01.testcorp.local
http_proxy_host = 192.168.1.254
http_proxy_port = 80
no_proxy = localhost, 127.0.0.1, *.testcorp.local

#Enable puppet services
systemctl enable --now puppetserver puppet

#Test that puppet agent is connecting to master
puppet agent -t

#Get list of all signed client certificates
puppetserver ca list --all

#Install a module from puppet forge
puppet module install puppetlabs/apache

#list puppet configuration
puppet config print
#See which config file is being used
puppet config print config
#See manifest info in the master section and for the production environment
puppet config print manifest --section master --environment production

###Bolt
apt install -y puppet-bolt
#Test
bolt command run whoami -t 127.0.0.1 -u user100 -p xxxx --no-host-key-check
bolt command run whoami -t ubuntu02.testcorp.local -u user100 -p xxx --no-host-key-check --run-as root
#Install puppet agent on remote host with bolt
bolt command run 'yum install -y https://yum.puppet.com/puppet6-release-el-7.noarch.rpm' -t centos02.testcorp.local -u root -p xxx --no-host-key-check
bolt command run 'yum install -y puppet-agent' -t centos02.testcorp.local -u root -p Parola#21 --no-host-key-check
bolt command run 'puppet config set server ubuntu01.testcorp.local --section main' -t centos02.testcorp.local -u root -p xx --no-host-key-check
bolt command run 'systemctl enable --now puppet' -t centos02.testcorp.local -u root -p xxx --no-host-key-check
#Check if the certificate of the machine is in the Requested section
puppetserver ca list
puppetserver ca sign --certname centos02.testcorp.local
#On the new server test the puppet agent (you may need to log in again for the PATH variable to refresh)

###Agent - Windows
Start-Process -FilePath "msiexec.exe" -ArgumentList "/qn",'/norestart','/i C:\Puppet\puppet-agent-x64-latest.msi','PUPPET_MASTER_SERVER=ubuntu01.testcorp.local' -Wait
#After install is done just sign the certificate on the puppet server